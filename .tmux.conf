# -- general
setw -g xterm-keys on
set -s escape-time 0
set -sg repeat-time 300
set -s focus-events on
set -s extended-keys on
set -as terminal-features 'xterm*:extkeys'
set -g mouse off # disable mouse support
set -sg exit-empty on
set -g detach-on-destroy off

set -q -g status-utf8 on
setw -q -g utf8 on

set -g visual-activity off
setw -g monitor-bell off
setw -g monitor-activity off # use alert to notify is better

set -g history-limit 20000

set -ga update-environment '\
DISPLAY DBUS_SESSION_BUS_ADDRESS \
QT_IM_MODULE QT_QPA_PLATFORMTHEME \
SESSION_MANAGER \
XDG_CONFIG_HOME XDG_CACHE_HOME XDG_DATA_HOME\
XDG_MENU_PREFIX XDG_RUNTIME_DIR XDG_SESSION_CLASS \
XDG_SESSION_DESKTOP XDG_SESSION_TYPE XDG_CURRENT_DESKTOP \
XMODIFIERS \
FZF_DEFAULT_OPTS \
TMUX_THEME_COLOR \
'
# Acknowledge the current pane's task when a client attaches (graceful if tracker unavailable)
# set-hook -ag client-attached 'run -b "test -x ~/.setup/agent-tracker/bin/tracker-client && ~/.setup/agent-tracker/bin/tracker-client command acknowledge --client #{client_tty} --session-id #{session_id} --window-id #{window_id} --pane #{pane_id} || true"'

# set-hook -ag pane-focus-in 'run -b "test -x ~/.setup/agent-tracker/bin/tracker-client && ~/.setup/agent-tracker/bin/tracker-client command acknowledge --client #{client_tty} --session-id #{session_id} --window-id #{window_id} --pane #{pane_id} || true"'
# set-hook -ag pane-died 'run -b "test -x ~/.setup/agent-tracker/bin/tracker-client && ~/.setup/agent-tracker/bin/tracker-client command delete_task --client #{client_tty} --session-id #{session_id} --window-id #{window_id} --pane #{pane_id} || true"'
# set-hook -ag pane-died 'run -b "test -x ~/.setup/agent-tracker/bin/tracker-client && ~/.setup/agent-tracker/bin/tracker-client command note_archive_pane --client #{client_tty} --session-id #{session_id} --window-id #{window_id} --pane #{pane_id} || true"'

# -- Project-specific window activation hooks
# Checks for ./on-tmux-window-activate.sh or ../on-tmux-window-activate.sh and runs it
# set-hook -ag after-select-window 'run-shell "~/.setup/tmux/scripts/check_and_run_on_activate.sh \"#{pane_current_path}\""'

# set-hook -gu session-created
# set-hook -ag session-created 'run -b "~/.setup/tmux/scripts/session_created.sh"'
# set-hook -ag session-created 'run -b "tmux refresh-client -S"'

# set-hook -gu session-renamed
# set-hook -g session-renamed 'run -b "tmux refresh-client -S"'

# set-hook -gu session-closed
# set-hook -g session-closed 'run -b "tmux refresh-client -S"'

# run-shell "~/.setup/tmux/scripts/session_created.sh"

# Display color
set -g default-terminal "screen-256color"
# set-option -ga terminal-overrides ",*256col*：Tc""

# Modify prefix keybind
unbind c-b
set -g prefix c-x

set-option -s set-clipboard off
#Use vim keybindings in copy mode
setw -g mode-keys vi
# start selecting text typing 'v' key (once you are in copy mode)
bind -T copy-mode-vi v send -X begin-selection
# Copy selected text to the system's clipboard
# You need to install xclip
# bind -T copy-mode-vi y send -X copy-pipe-and-cancel "xclip -i -f -selection primary | xclip -i -selection clipboard"
bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "~/.setup/tmux/scripts/copy_to_clipboard.sh"
bind -T copy-mode-vi , send -X scroll-up
bind -T copy-mode-vi . send -X scroll-down
bind -T copy-mode-vi n send -X search-reverse
bind -T copy-mode-vi N send -X search-again
bind -n M-v copy-mode -u
bind -T copy-mode-vi C-v send -X page-down
bind k copy-mode
# bind -n c-y pipe-pane -I "xclip -o"
bind -n c-y run -b "~/.setup/tmux/scripts/paste_from_clipboard.sh"

unbind ,
bind , command-prompt -I "#W" -p "Rename window:" "rename-window '%%'"
unbind .
# bind . command-prompt -I "#S" -p "Rename session:" "rename-session '%%'"
bind . command-prompt -p "Rename session:" "run-shell \"~/.setup/tmux/scripts/rename_session_prompt.sh '%%'\""

bind -n M-t run-shell "test -x ~/.setup/agent-tracker/bin/tracker-client && ~/.setup/agent-tracker/bin/tracker-client command toggle --client '#{client_tty}' || true"
bind -n M-m run-shell "test -f ~/.setup/agent-tracker/scripts/focus_latest_notified.sh && bash ~/.setup/agent-tracker/scripts/focus_latest_notified.sh || true"
bind -n M-M run-shell "test -f ~/.setup/agent-tracker/scripts/focus_last_origin.sh && bash ~/.setup/agent-tracker/scripts/focus_last_origin.sh || true"
bind Space run-shell "~/.setup/tmux/scripts/toggle_orientation.sh"

bind W choose-tree -Z
bind S choose-tree 'move-pane -v -s "%%"'
bind V choose-tree 'move-pane -h -s "%%"'

# pane resizing
bind -n M-h resize-pane -L 3
bind -n M-l resize-pane -R 3
bind -n M-j resize-pane -D 3
bind -n M-k resize-pane -U 3
# maximize pane or restore
bind -n M-m resize-pane -Z

bind b list-buffers
bind p paste-buffer

# -- toggle_syn_input
bind C-g if-shell '[[ $(tmux showw synchronize-panes | cut -d\  -f2) == "on" ]]' \
'setw synchronize-panes off; set -g pane-border-style fg=#{?#{!=:#{environ:TMUX_THEME_COLOR},},#{environ:TMUX_THEME_COLOR},#b294bb}' \
'setw synchronize-panes on; set -g pane-border-style fg=red'

set -g status-keys emacs

bind x confirm-before -p "Kill session '#S' and all its processes? (y/n)" \
    'run-shell "tmux kill-session -t \"#S\""'
# bind -n c-y paste-buffer

# for mingw
# bind -T copy-mode-vi v send-keys -X beging-selection
# bind -T copy-mode-vi y send-keys -X copy-pipe "cat &> /dev/clipboard"
## bind -T copy-mode-vi y send-keys -X copy-selection-and-cancel
# bind -T copy-mode-vi , send-keys -X scroll-up
# bind -T copy-mode-vi . send-keys -X scroll-down
# bind -n M-v copy-mode -u
# bind -T copy-mode-vi C-v send-keys -X page-down
# bind k copy-mode
# bind -n C-y paste-buffer


# Modify pane and window select keybindings
#bind 2 splitw -v -p 50
#bind 3 splitw -h -p 50
# For version > 3.4
bind 2 splitw -v -l 50%
bind 3 splitw -h -l 50%
# bind k confirm-before -p "kill-pane #P? (y/n)" kill-pane
bind -n M-n next-window
bind -n M-p previous-window

# bind -n M-h selectw -t 1
# bind -n M-l last
# bind -n M-L switchc -l
bind -n M-N switchc -n
bind -n M-P switchc -p
bind -n M-s choose-client

bind -n 'M-!' selectw -t 1
bind -n 'M-@' selectw -t 2
bind -n 'M-#' selectw -t 3
bind -n 'M-$' selectw -t 4
bind -n 'M-%' selectw -t 5
bind -n 'M-^' selectw -t 6
bind -n 'M-&' selectw -t 7
bind -n 'M-*' selectw -t 8
bind -n 'M-(' selectw -t 9

bind -n M-1 selectp -t 1
bind -n M-2 selectp -t 2
bind -n M-3 selectp -t 3
bind -n M-4 selectp -t 4
bind -n M-5 selectp -t 5
bind -n M-6 selectp -t 6
bind -n M-7 selectp -t 7
bind -n M-8 selectp -t 8
bind -n M-9 selectp -t 9
#bind -n M-Left select-pane -L

# -- display
set -g base-index 1
setw -g pane-base-index 1

set -g set-titles off

set -g display-panes-time 2000
set -g display-time 2000


# -- navigation

# create session
bind n run-shell "~/.setup/tmux/scripts/new_session.sh"
# bind -n M-O break-pane
bind -n M-o new-window

# panes
run-shell "~/.setup/tmux/scripts/update_theme_color.sh"
setw -g pane-border-status top
set -g pane-active-border-style fg=#b294bb
set -g pane-border-style fg=colour244
# setw -g pane-border-format '#{?pane_active, #[fg=#{@theme_color}]#[bg=#{@theme_color}]#[fg=#1d1f21]#[bold] #{?window_zoomed_flag,⛶ ,} #(~/.setup/tmux/scripts/pane_starship_title.sh #{pane_pid} #{pane_width} "#{pane_current_path}" "#{pane_current_command}") #[bg=default]#[fg=#{@theme_color}]#[default], #[fg=colour244]#[bg=colour244]#[fg=#1d1f21] #{?window_zoomed_flag,⛶ ,} #(~/.setup/tmux/scripts/pane_starship_title.sh #{pane_pid} #{pane_width} "#{pane_current_path}" "#{pane_current_command}") #[bg=default]#[fg=colour244]#[default] }'
setw -g pane-border-format '#{?pane_active, #[fg=#{@theme_color}]#[bg=#{@theme_color}]#[fg=#1d1f21]#[bold] #{?window_zoomed_flag,⛶ ,} #(echo #{pane_current_path} | sed "s|^$HOME|~|" | rev | cut -d/ -f1-5 | rev)/ - #{pane_current_command} #[bg=default]#[fg=#{@theme_color}]#[default], #[fg=colour244]#[bg=colour244]#[fg=#1d1f21] #{?window_zoomed_flag,⛶ ,} #(echo #{pane_current_path} | sed "s|^$HOME|~|" | rev | cut -d/ -f1-5 | rev)/ - #{pane_current_command} #[bg=default]#[fg=colour244]#[default] }'
#set -g pane-active-border-style fg=brightblue
#set -g pane-border-style fg=magenta

# Let mouse can select pane
### setw = set-window-option
# setw -g mode-mouse on
# setw -g mouse-resize-pane on
# setw -g mouse-select-pane on
# setw -g mouse-select-window on
bind M set-option -g mouse on
bind m set-option -g mouse off

setw -g automatic-rename off
setw -g allow-rename off

bind R source-file ~/.tmux.conf \; display-message "Config Reloaded!"

# Status bar
# set -g status-utf8 on
set -g status-interval 2  # refresh interval
set -g status-bg black
set -g status-fg cyan

set-option -g status-justify centre # alignment

setw -g window-status-format '#[dim]#I-#W#[fg=cyan, dim]'
setw -g window-status-current-format '#[fg=#269b62]#[bg=#269b62]#[fg=blue]#I#[fg=blue]-#[fg=blue]#W#[bg=#1d1f21]#[fg=#269b62]'

# Highlight current pane
# black red green blue magenta cyan white
setw -g window-status-current-style bg=black
# set -g message-style "bg=,fg="

set -g status-left-length 90
set -g status-right-length 140
set -g status-left "#(~/.setup/tmux/tmux-status/left.sh \"#{session_id}\" \"#{session_name}\")   "
set -g status-right "#(~/.setup/tmux/tmux-status/right.sh)"
# #I : order num    #w: window name    #F: blank char    #S: session name
# set -g status-left '#[bg=black, fg=green][#[fg=cyan]#S#[fg=green]]'
set -g status-right '#(byobu-status tmux_right)#[fg=green][#[fg=cyan]%Y-%m-%d %H:%M:%S#[fg=green]]'

